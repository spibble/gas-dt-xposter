<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous">
</script>

<script>
  $(document).ready(function() {  
    $('#post-form').submit(onPostFormSubmit);
    var status = $('#submit-status');
    status.hide();

    google.script.run
      .withSuccessHandler(updateSelectedCell)
      .getSelectedCell();
  })

  function showStatus(message) {
    var status = $('#submit-status');
    status.removeClass('error')
    status.text(message);
    status.show();
  }

  function updateSelectedCell(cellA1) {
    const cellInput = document.getElementById('selected-cell');
    cellInput.value = cellA1;
  }

  function processUpload(image) {
    var reader = new FileReader();

    if (image) {
        reader.readAsDataURL(image);
    }

    return new Promise((resolve, reject) => {
      reader.onload = function(event) {
        resolve(event.target.result);
      };
    })
  }

  // thing that calls into AnnounceHelper.gs
  function startAnnouncement(contents) {
    showStatus('Sending out announcements...');
    google.script.run
    .withSuccessHandler(showStatus('Done!'))
    .announce(contents);
  }

  // thing that runs when you click the button
  async function onPostFormSubmit(event) {
    event.preventDefault();
    this.disabled = true;
    showStatus('Starting...');

    const form = document.getElementById('post-form');
    const elements = form.elements;

    const cellA1 = elements["selected-cell"].value;
    const image = elements["selected-image"].files[0];

    if (image) {
      // converting the image to b64 is necessary to prevent frying GAS's brain
      const base64Image = await processUpload(image);

      google.script.run
        .withSuccessHandler(startAnnouncement)
        .processForm(cellA1, base64Image);
    } else {
      google.script.run
        .withSuccessHandler(startAnnouncement)
        .processForm(cellA1, null);
    }
  }
</script>